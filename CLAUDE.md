# CLAUDE.md

## Project Overview

VoiceHUD is a voice training web application. It provides real-time voice visualization (pitch, resonance, spectrogram) and AI-powered voice analysis via multiple providers.

## Tech Stack

- **Framework**: TanStack Start (React, file-based routing, SSR via Vite)
- **Styling**: Tailwind CSS v4 + shadcn/ui (new-york style, zinc base color)
- **AI**: Vercel AI SDK with Google Gemini, OpenRouter, and OpenAI-compatible providers
- **Audio**: Web Audio API with custom YIN pitch detection (no external audio libs)
- **Deploy target**: Cloudflare Workers via `@cloudflare/vite-plugin`
- **Package manager**: pnpm

## Commands

```bash
pnpm dev          # Start dev server on port 3000
pnpm build        # Production build (outputs to dist/)
pnpm deploy       # Build + deploy to Cloudflare Workers
```

## Architecture Notes

### Routing

File-based routing in `src/routes/`. TanStack Router auto-generates `src/routeTree.gen.ts` — do not edit this file manually. New routes are added by creating files in `src/routes/`.

### Client-Side Only Architecture

All API calls to AI providers happen in the browser (client-side). Users provide their own API keys which are stored in `localStorage`. There are no server-side secrets or server functions proxying API calls.

### Audio Processing Pipeline

```
Microphone → AudioContext → AnalyserNode → Float32Array
  ├── YIN Algorithm → Pitch (Hz)
  ├── Spectral Peak Detection → Formants (F1, F2, F3)
  └── Byte Frequency Data → Spectrogram / Volume
```

All audio processing runs in the main thread via `requestAnimationFrame`. The YIN implementation is in `src/lib/audio/pitch-detection.ts`.

### AI Provider Abstraction

`src/lib/ai/` contains the provider system:
- `providers.ts` — Provider presets (Google, OpenRouter, Zenmux, Custom) and types
- `client.ts` — Unified `analyzeVoice()` using `generateText` from Vercel AI SDK
- `storage.ts` — localStorage persistence for provider config

To add a new provider preset, add an entry to `PROVIDER_PRESETS` in `providers.ts`. If it's OpenAI-compatible, set `type: 'openai-compatible'`. The `client.ts` handles routing to the correct SDK.

### i18n

Simple context-based i18n in `src/lib/i18n/`. All UI text is in `zh.ts` and `en.ts` as plain objects. Use `useI18n()` hook to access translations. When adding new UI text, add keys to both files.

### Cloudflare Deployment

`vite.config.ts` uses `@cloudflare/vite-plugin` with `{ viteEnvironment: { name: 'ssr' } }`. The `wrangler.jsonc` sets `"main": "@tanstack/react-start/server-entry"` which the Cloudflare Vite Plugin resolves as a virtual module at build time. Do **not** use `nitro()` plugin alongside `cloudflare()` — they are mutually exclusive.

### Import Aliases

- `#/*` → `./src/*` (configured in `package.json` `imports` field)
- `@/*` → `./src/*` (configured in `tsconfig.json` `paths`)

Use `#/` for runtime imports (components, hooks, lib). The `@/` alias is for TypeScript path resolution.

## Key Files

| File | Purpose |
|------|---------|
| `vite.config.ts` | Vite + Cloudflare + TanStack Start + Tailwind config |
| `wrangler.jsonc` | Cloudflare Workers deployment config |
| `components.json` | shadcn/ui configuration |
| `src/routes/__root.tsx` | Root layout with i18n provider |
| `src/lib/audio/pitch-detection.ts` | YIN pitch detection algorithm |
| `src/lib/ai/client.ts` | Unified AI voice analysis client |
| `src/lib/ai/providers.ts` | Provider presets and types |
| `src/lib/training/exercises.ts` | Exercise definitions (bilingual) |
| `src/lib/training/programs.ts` | Training program schedules |

## Style Conventions

- Dark theme (slate-900/950 backgrounds, cyan-400 accent)
- Components use Tailwind utility classes directly
- shadcn/ui components go in `src/components/ui/`
- Application components in `src/components/` organized by feature
